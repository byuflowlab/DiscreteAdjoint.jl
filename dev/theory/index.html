<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Theory · DiscreteAdjoint.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link rel="canonical" href="https://byuflowlab.github.io/DiscreteAdjoint.jl/theory/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">DiscreteAdjoint.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../guide/">Usage</a></li><li class="is-active"><a class="tocitem" href>Theory</a><ul class="internal"><li><a class="tocitem" href="#Implementation"><span>Implementation</span></a></li><li><a class="tocitem" href="#Computing-Partial-Derivatives"><span>Computing Partial Derivatives</span></a></li><li><a class="tocitem" href="#Comparison-with-Automatic-Differentiation"><span>Comparison with Automatic Differentiation</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Theory</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Theory</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/byuflowlab/DiscreteAdjoint.jl/blob/main/docs/src/theory.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="theory"><a class="docs-heading-anchor" href="#theory">Discrete Adjoint Derivation</a><a id="theory-1"></a><a class="docs-heading-anchor-permalink" href="#theory" title="Permalink"></a></h1><p>We can view the time integration of any ordinary differential equation as a collection of residual expressions representing an initialization step and a sequence of discrete integration steps from <span>$t_0$</span> to <span>$t_{n}$</span>.</p>$<p>R(x, p, t) = \begin{bmatrix} r<em>0(x</em>0, p, t<em>0) \
r</em>1(x<em>{0 \cdots 1}, p, t</em>{0 \cdots 1}) \
r<em>2(x</em>{0 \cdots 2}, p, t<em>{0 \cdots 2}) \
r</em>3(x<em>{0 \cdots 3}, p, t</em>{0 \cdots 3}) \
\vdots \
r<em>n(x</em>{0 \cdots n}, p, t_{0 \cdots n}) \
\end{bmatrix} = 0 $</p><p>We are interested in some function of interest (FOI) <span>$G(x,p)$</span> which may be calculated from the values of the state variables throughout the simulation as well as the parameters.  </p><p>We would like to obtain the total derivative of the FOI with respect to the parameters</p>$<p>\frac{d G}{d p} = \frac{\partial G}{\partial p} + \frac{\partial G}{\partial x} \frac{d x}{d p} $</p><p>An expression for the total derivative <span>$\frac{d x}{d p}$</span> may be found by taking the total derivative of the residual expression <span>$R(x, p, t)$</span></p>$<p>\frac{d R}{d p} = \frac{\partial R}{\partial p} + \frac{\partial R}{\partial x} \frac{d x}{d p} = 0 $</p>$<p>\frac{d x}{d p} = -\left(\frac{\partial R}{\partial x}\right)^{-1} \frac{\partial R}{\partial p} $</p><p>Substituting this expression in for <span>$\frac{d x}{d p}$</span> allows us to compute <span>$\frac{d G}{d p}$</span> using only partial derivatives.</p>$<p>\frac{d G}{d p} = \frac{\partial G}{\partial p} - \frac{\partial G}{\partial x} \left(\frac{\partial R}{\partial x}\right)^{-1} \frac{\partial R}{\partial p} $</p><p>For the adjoint method we first solve</p>$<p>\lambda^* = \frac{\partial G}{\partial x} \left(\frac{\partial R}{\partial x}\right)^{-1} $</p><p>and then compute the total derivative as</p>$<p>\frac{d G}{d p} = \frac{\partial G}{\partial p} - \lambda^* \frac{\partial R}{\partial p} $</p><h2 id="Implementation"><a class="docs-heading-anchor" href="#Implementation">Implementation</a><a id="Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation" title="Permalink"></a></h2><p>In general, <span>$\frac{\partial R}{\partial x}$</span> is large lower-triangular square matrix, <span>$\frac{\partial R}{\partial p}$</span> is large tall matrix, and <span>$\frac{\partial R}{\partial p}$</span> is a large wide matrix. For performance and memory reasons, <span>$\frac{\partial R}{\partial x}$</span>, <span>$\frac{\partial R}{\partial p}$</span>, and <span>$\frac{\partial R}{\partial p}$</span> shouldn&#39;t be explictly constructed.  Instead, the sparsity structure of <span>$\frac{\partial R}{\partial x}$</span> should be exploited so that only a small portion of <span>$\frac{\partial R}{\partial x}$</span>, <span>$\frac{\partial R}{\partial p}$</span>, and <span>$\frac{\partial R}{\partial p}$</span> needs to be held in memory at the same time.  On the other hand, the partial derivative matrix <span>$\frac{\partial G}{\partial p}$</span> is relatively small and may therefore be constructed explicitly without introducing any significant performance penalties.  This section explains the procedure for calculating the total derivative without explicitly constructing <span>$\frac{\partial R}{\partial x}$</span>, <span>$\frac{\partial R}{\partial p}$</span>, or <span>$\frac{\partial R}{\partial p}$</span>.</p><p>The adjoint vector <span>$\lambda$</span> may be formed by solving the following equation $ \begin{bmatrix} {\frac{\partial r<em>0}{\partial x</em>0}}^* &amp; \frac{\partial r<em>1}{\partial x</em>0}^* &amp; \cdots &amp; \frac{\partial r<em>{n-1}}{\partial x</em>0}^* &amp; \frac{\partial r<em>{n}}{\partial x</em>0}^* \
 &amp; \frac{\partial r<em>1}{\partial x</em>1}^* &amp; \cdots &amp; \frac{\partial r<em>{n-1}}{\partial x</em>1}^* &amp; \frac{\partial r<em>n}{\partial x</em>1}^* \
 &amp;  &amp; \ddots &amp; \vdots &amp; \vdots \
  &amp; &amp; &amp;  \frac{\partial r<em>{n-1}}{\partial x</em>{n-1}}^* &amp; \frac{\partial r<em>n}{\partial x</em>{n-1}}^<em>\
 &amp; &amp; &amp; &amp; \frac{\partial r<em>n}{\partial x</em>n}^</em> \end{bmatrix} \begin{bmatrix}   \lambda<em>0 \
  \lambda</em>1 \
  \vdots &amp; \
  \lambda<em>{n-1} \
  \lambda</em>n \end{bmatrix}  =  \begin{bmatrix}   \frac{\partial G}{\partial x<em>0}^* \
  \frac{\partial G}{\partial x</em>1}^* \
  \vdots \
  \frac{\partial G}{\partial x<em>{n-1}}^* \
  \frac{\partial G}{\partial x</em>n}^* \end{bmatrix} $ This matrix problem may be solved iteratively starting from the final time step using the following expression. $ \frac{\partial r<em>i}{\partial x</em>i}^* \lambda<em>i = \frac{\partial G}{\partial x</em>i}^* - \sum<em>{k=i+1}^n \left( \lambda</em>k^* \frac{\partial r<em>k}{\partial x</em>i} \right)^* $ In practice, state variables from only a limited number of  previous time steps are used to compute state variables for the current time step, so only a few terms from the summation are actually needed to compute the adjoint vector.  </p><p>The elements of the adjoint vector may be mutliplied by the elements of <span>$\frac{\partial R}{\partial p}$</span> and summed with <span>$\frac{\partial G}{\partial p}$</span> as they are computed to calculate the total derivative <span>$\frac{d G}{d p}$</span> $ \frac{d G}{d p} = \frac{\partial G}{\partial p} - \sum<em>{i=0}^n \lambda</em>i^* \frac{\partial r_i}{\partial p} $</p><h2 id="Computing-Partial-Derivatives"><a class="docs-heading-anchor" href="#Computing-Partial-Derivatives">Computing Partial Derivatives</a><a id="Computing-Partial-Derivatives-1"></a><a class="docs-heading-anchor-permalink" href="#Computing-Partial-Derivatives" title="Permalink"></a></h2><p>The vector-transpose Jacobian products <span>$\lambda_k^* \frac{\partial r_k}{\partial x_i}$</span> and <span>$\lambda_i^* \frac{\partial r_i}{\partial p}$</span> may be computed efficiently without forming the Jacobian using reverse-mode automatic differentiation.  The remaining partial derivatives <span>$\frac{\partial r_i}{\partial x_i}$</span>, <span>$\frac{\partial G}{\partial x_i}$</span> and <span>$\frac{\partial G}{\partial p}$</span> may be provided analytically or computed using numerical or automatic differentiation.</p><h3 id="Explicit-Midpoint-Method-with-an-Explicit-ODE"><a class="docs-heading-anchor" href="#Explicit-Midpoint-Method-with-an-Explicit-ODE">Explicit Midpoint Method with an Explicit ODE</a><a id="Explicit-Midpoint-Method-with-an-Explicit-ODE-1"></a><a class="docs-heading-anchor-permalink" href="#Explicit-Midpoint-Method-with-an-Explicit-ODE" title="Permalink"></a></h3><p>The residual function for each time step takes the following form $ r(x<em>i, x</em>{i+1}, p, t<em>i, t</em>{i+1}) = x<em>{i+1} - x</em>i - (t<em>{i+1} - t</em>{i}) f \left(x<em>i + \frac{t</em>i + t<em>{i+1}}{2} f(x</em>i, p, t<em>i), p, t</em>i + \frac{t<em>{i+1} - t</em>{i}}{2} \right) $ where <span>$f$</span> is our underlying ordinary differential equation.</p><p>The jacobians <span>$\frac{\partial r_i}{\partial x_i}$</span>, <span>$\frac{\partial r_i}{\partial x_{i-1}}$</span>, and <span>$\frac{\partial r_i}{\partial p}$</span> may then be defined analytically as</p>$<p>\frac{\partial r<em>i}{\partial x</em>{i+1}} = I $ </p>$<p>\frac{\partial r<em>i}{\partial x</em>{i}} = -I - (t<em>{i+1} - t</em>{i}) \left( \frac{\partial f}{\partial x<em>{i}} \left(x</em>i + \frac{t<em>i + t</em>{i+1}}{2} f(x<em>i, p, t</em>i), p, t<em>i + \frac{t</em>{i+1} - t<em>{i}}{2} \right) \left(1 + \frac{t</em>{i+1} - t<em>{i}}{2}\frac{\partial f}{\partial x</em>{i}}( x<em>i, p</em>i, t)  \right) \right) $ </p>$<p>\frac{\partial r<em>i}{\partial p} = - (t</em>{i+1} - t<em>{i}) \left(\frac{\partial f}{\partial p} \left(x</em>i + \frac{t<em>i + t</em>{i+1}}{2} f(x<em>i, p, t</em>i), p, t<em>i + \frac{t</em>{i+1} - t<em>{i}}{2} \right) +    \frac{\partial f}{\partial x} \left(x</em>i + \frac{t<em>i + t</em>{i+1}}{2} f(x<em>i, p, t</em>i), p, t<em>i + \frac{t</em>{i+1} - t<em>{i}}{2} \right) \left(\frac{t</em>i + t<em>{i+1}}{2} \frac{\partial f}{\partial p}(x</em>i, p, t_i)\right) \right) $</p><p>The jacobians <span>$\frac{\partial f}{\partial x}$</span> and <span>$\frac{\partial f}{\partial p}$</span> may be provided analytically or computed using numerical or automatic differentiation.  Note that since this method is explicit, identity matrices will occupy the diagonal of <span>$\frac{\partial R}{\partial x}$</span>.  The adjoint vector may therefore be found without performing a linear solve to calculate each portion of the adjoint vector</p><h3 id="Implicit-Midpoint-Method-with-an-Explicit-ODE"><a class="docs-heading-anchor" href="#Implicit-Midpoint-Method-with-an-Explicit-ODE">Implicit Midpoint Method with an Explicit ODE</a><a id="Implicit-Midpoint-Method-with-an-Explicit-ODE-1"></a><a class="docs-heading-anchor-permalink" href="#Implicit-Midpoint-Method-with-an-Explicit-ODE" title="Permalink"></a></h3><p>The residual function for each time step takes the following form $ r(x<em>i, x</em>{i+1}, p, t<em>i, t</em>{i+1}) = x<em>{i+1} - x</em>i - (t<em>{i+1} - t</em>{i}) f \left( \frac{x<em>i + x</em>{i+1}}{2}, p, t<em>i + \frac{t</em>{i+1} - t_{i}}{2} \right) $ where <span>$f$</span> is our underlying ordinary differential equation.</p><p>The jacobians <span>$\frac{\partial r_i}{\partial x_i}$</span>, <span>$\frac{\partial r_i}{\partial x_{i-1}}$</span>, and <span>$\frac{\partial r_i}{\partial p}$</span> may then be defined analytically as</p>$<p>\frac{\partial r<em>i}{\partial x</em>{i+1}} = I - (t<em>{i+1} - t</em>{i}) \frac{\partial f}{\partial x<em>{i}} \left( \frac{x</em>i + x<em>{i+1}}{2}, p, t</em>i + \frac{t<em>{i+1} - t</em>{i}}{2} \right) \left( \frac{1}{2} \right) $ </p>$<p>\frac{\partial r<em>i}{\partial x</em>{i}} = -I - (t<em>{i+1} - t</em>{i}) \frac{\partial f}{\partial x<em>{i}} \left( \frac{x</em>i + x<em>{i+1}}{2}, p, t</em>i + \frac{t<em>{i+1} - t</em>{i}}{2} \right)\left( \frac{1}{2} \right) $ </p>$<p>\frac{\partial r<em>i}{\partial p} = - (t</em>{i+1} - t<em>{i}) \frac{\partial f}{\partial p} \left( \frac{x</em>i + x<em>{i+1}}{2}, p, t</em>i + \frac{t<em>{i+1} - t</em>{i}}{2} \right) $</p><p>The jacobians <span>$\frac{\partial f}{\partial x}$</span> and <span>$\frac{\partial f}{\partial p}$</span> may be provided analytically or computed using numerical or automatic differentiation.</p><h3 id="DABDF2-with-an-Implicit-ODE"><a class="docs-heading-anchor" href="#DABDF2-with-an-Implicit-ODE">DABDF2 with an Implicit ODE</a><a id="DABDF2-with-an-Implicit-ODE-1"></a><a class="docs-heading-anchor-permalink" href="#DABDF2-with-an-Implicit-ODE" title="Permalink"></a></h3><p>The residual function for each time step takes the following form $ r(x^{i-2 \cdots i}, p, t^{i-2 \cdots i}) = f\left( \gamma \left( t<em>i - t</em>{i-1} \right) \left(x<em>{i} + \left(c - 1 \right) x</em>{i-1} - c x<em>{i-2}\right), x</em>{i}, p, t<em>{i}\right) $  where  $ \rho = \frac{t</em>i - t<em>{i-1}}{t</em>{i-1} - t_{i-2}} \quad \gamma = \frac{1+\rho}{1+2\rho} \quad c = \frac{\rho^2}{1 + 2 \rho} $ and <span>$f$</span> is our underlying implicit ordinary differential equation.  Note that this residual function depends on the state variables from the <span>$i-2$</span> iteration, so the adjoint equations must be modified accordingly.</p><p>The jacobians <span>$\frac{\partial r_i}{\partial x_i}$</span>, <span>$\frac{\partial r_i}{\partial x_{i-1}}$</span>, <span>$\frac{\partial r_i}{\partial x_{i-2}}$</span>, and <span>$\frac{\partial r_i}{\partial p}$</span> may be defined analytically as</p>$<p>\frac{\partial r<em>i}{\partial x</em>{i}} = \frac{\partial f}{\partial \dot{x}} \left( \gamma \left( t<em>i - t</em>{i-1} \right) \left(x<em>{i} - \left(c - 1 \right) x</em>{i-1} + c x<em>{i-2}\right), x</em>{i}, p, t<em>{i}\right)\gamma \left( t</em>i - t<em>{i-1} \right) + \frac{\partial f}{\partial x} \left( \gamma \left( t</em>i - t<em>{i-1} \right) \left(x</em>{i} - \left(c - 1 \right) x<em>{i-1} + c x</em>{i-2}\right), x<em>{i}, p, t</em>{i}\right) $ </p>$<p>\frac{\partial r<em>i}{\partial x</em>{i-1}} = \frac{\partial f}{\partial \dot{x}} \left( \gamma \left( t<em>i - t</em>{i-1} \right) \left(x<em>{i} - \left(c - 1 \right) x</em>{i-1} + c x<em>{i-2}\right), x</em>{i}, p, t<em>{i}\right)\gamma \left( t</em>i - t_{i-1} \right)(c-1) $ </p>$<p>\frac{\partial r<em>i}{\partial x</em>{i-2}} = \frac{\partial f}{\partial \dot{x}} \left( \gamma \left( t<em>i - t</em>{i-1} \right) \left(x<em>{i} - \left(c - 1 \right) x</em>{i-1} + c x<em>{i-2}\right), x</em>{i}, p, t<em>{i}\right)\gamma \left( t</em>i - t_{i-1} \right)(-c) $ </p>$<p>\frac{\partial r<em>i}{\partial p} = \frac{\partial f}{\partial p} \left( \gamma \left( t</em>i - t<em>{i-1} \right) \left(x</em>{i} - \left(c - 1 \right) x<em>{i-1} + c x</em>{i-2}\right), x<em>{i}, p, t</em>{i}\right) $</p><h2 id="Comparison-with-Automatic-Differentiation"><a class="docs-heading-anchor" href="#Comparison-with-Automatic-Differentiation">Comparison with Automatic Differentiation</a><a id="Comparison-with-Automatic-Differentiation-1"></a><a class="docs-heading-anchor-permalink" href="#Comparison-with-Automatic-Differentiation" title="Permalink"></a></h2><p>The discrete adjoint may also be implemented by using reverse-mode automatic differentiation across the entire time integration process.  In practice, however, compiling time and memory requirements for reverse-mode automatic differentiation are often prohibitively high when applied across the entire time integration process.  A combination of analytic expressions and automatic differentiation may therefore offer the best solution.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../guide/">« Usage</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Saturday 17 September 2022 00:52">Saturday 17 September 2022</span>. Using Julia version 1.8.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
